<!DOCTYPE html>
<html lang="zh_cn">
<head>
        <meta charset="utf-8" />
        <title>Hsu's Home - gevent]</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Hsu's Home </a></h1>
                <nav><ul>
                    <li><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/2017-8-27-python-xie-cheng-jia-su.html">2017-8-27 python 协程加速</a></h1>
<footer class="post-info">
        <abbr class="published" title="2017-08-27T16:05:58+08:00">
                Published: Sun 27 August 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/chihwei-hsu.html">Chihwei-Hsu</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/python.html">[Python</a> <a href="/tag/gevent.html">gevent]</a> </p>
</footer><!-- /.post-info --><h3>情景描述：</h3>
<blockquote>
<p>上周，由于产品嫌报告生成太慢，经过使用<code>profile/gprof2dot</code>研究后，发现主要时间耗费在接口网络请求上，于是我决定在项目中大量处理I/O网络请求的地方使用<code>gevent</code>,以缓解报告生成压力。</p>
</blockquote>
<!--more-->

<h3>实现代码：</h3>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gevent</span>
<span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span><span class="p">,</span> <span class="n">pool</span>
<span class="n">monkey</span><span class="o">.</span><span class="n">patch_socket</span><span class="p">()</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">requests_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tel_tuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    主要处理requests请求</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Size of pool&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="err">……</span>
    <span class="err">……</span>

<span class="k">def</span> <span class="nf">generator_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tel_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    使用gevent实现协程处理I/O网络请求</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests_parse</span><span class="p">,</span> <span class="n">tel</span><span class="p">)</span> <span class="k">for</span> <span class="n">tel</span> <span class="ow">in</span> <span class="n">tel_data</span><span class="p">]</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>

    <span class="n">tlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
        <span class="n">message_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">exception</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">tlist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message_list</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tlist</span>

<span class="k">def</span> <span class="nf">update_data_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    主要将请求回来处理好的数据写入数据库（mongo）</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="err">……</span>
    <span class="err">……</span>

<span class="n">tel_data</span> <span class="o">=</span> <span class="p">[</span><span class="err">……</span><span class="p">]</span> <span class="c1"># 一大堆待请求参数list</span>
<span class="n">tlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_label</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tel_data</span><span class="p">))</span>
<span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_data_step</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="n">tlist</span><span class="p">)</span>
</pre></div>


<h3>问题：</h3>
<blockquote>
<p>上线后发现，代码运行一段时间后，请求一上来，任务数直线上升，一直增加：
<img alt="enter description here" src="http://ohhmsby4v.bkt.clouddn.com/image/2017-8-27%20python%20%E5%8D%8F%E7%A8%8B%E5%8A%A0%E9%80%9F_1.png">
但是，pool的数量是正常的：
<img alt="enter description here" src="http://ohhmsby4v.bkt.clouddn.com/image/2017-8-27%20python%20%E5%8D%8F%E7%A8%8B%E5%8A%A0%E9%80%9F_2.png">
之后log里报错信息：</p>
</blockquote>
<div class="highlight"><pre><span></span>  <span class="n">File</span> <span class="s2">&quot;run.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">42</span><span class="p">,</span> <span class="ow">in</span> <span class="n">update_data</span>
  <span class="n">File</span> <span class="s2">&quot;report/generate/calls_sa_by_tel.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">396</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
  <span class="n">File</span> <span class="s2">&quot;report/generate/calls_sa_by_tel.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">38</span><span class="p">,</span> <span class="ow">in</span> <span class="n">base_call</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/cursor.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">729</span><span class="p">,</span> <span class="ow">in</span> <span class="n">count</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/collection.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1344</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_count</span>
  <span class="n">File</span> <span class="s2">&quot;/usr/lib64/python2.7/contextlib.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">17</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__enter__</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/mongo_client.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">904</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_socket_for_reads</span>
  <span class="n">File</span> <span class="s2">&quot;/usr/lib64/python2.7/contextlib.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">17</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__enter__</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/mongo_client.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">870</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_get_socket</span>
  <span class="n">File</span> <span class="s2">&quot;/usr/lib64/python2.7/contextlib.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">17</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__enter__</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/server.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">168</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get_socket</span>
  <span class="n">File</span> <span class="s2">&quot;/usr/lib64/python2.7/contextlib.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">17</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__enter__</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/pool.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">844</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get_socket</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/pool.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">881</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_get_socket_no_auth</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/pool.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">817</span><span class="p">,</span> <span class="ow">in</span> <span class="n">connect</span>
  <span class="n">File</span> <span class="s2">&quot;venv/lib/python2.7/site-packages/pymongo/pool.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">263</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_raise_connection_failure</span>
<span class="n">AutoReconnect</span><span class="p">:</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span><span class="p">:</span><span class="mi">27017</span><span class="p">:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">24</span><span class="p">]</span> <span class="n">Too</span> <span class="n">many</span> <span class="nb">open</span> <span class="n">files</span>
</pre></div>


<h3>解决办法：</h3>
<blockquote>
<p>经过分析，解决办法：<code>monkey.patch_socket()</code>换为<code>monkey.patch_all()</code>，或者，在使用完<code>gevent</code>后使用<code>reload(socket)</code>将socket初始化。
原因：应该是mongo写数据是阻塞的，请求快于写操作，导致写操作堆积越来越多，最终导致程序抛出<code>Too many open files</code>错误。
最终代码，如下：</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gevent</span>
<span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span><span class="p">,</span> <span class="n">pool</span>
<span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">generator_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tel_data</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests_parse</span><span class="p">,</span> <span class="n">tel</span><span class="p">)</span> <span class="k">for</span> <span class="n">tel</span> <span class="ow">in</span> <span class="n">tel_data</span><span class="p">]</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
    <span class="c1"># print [x.value for x in jobs]</span>
    <span class="n">tlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
        <span class="n">message_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">exception</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">tlist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message_list</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tlist</span>


<span class="c1"># 或者使用</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests_parse</span><span class="p">,</span> <span class="n">tel</span><span class="p">)</span> <span class="k">for</span> <span class="n">tel</span> <span class="ow">in</span> <span class="n">tel_data</span><span class="p">]</span>
<span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="nb">reload</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
</pre></div>


<h4>另一个用例：</h4>
<blockquote>
<p>给传递两个参数，直接后面跟着就行，逗号分开；
返回如是多个情况的，value是一个以tuple为元素的list。</p>
</blockquote>
<div class="highlight"><pre><span></span>    <span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># date (&#39;2017-07-01&#39;, &#39;2017-07-14&#39;)</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crawl_a_call_log</span><span class="p">,</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">]</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">data_list</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
        <span class="n">message_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">exception</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;crawler&#39;</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">message_list</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message_list</span><span class="p">)</span>
</pre></div>


<h3>总结</h3>
<blockquote>
<p>协程(gevent)是把双刃剑，monkey.patch 是一个邪恶的东西；
提升效果不要太好，耗时足足降了60%，而且，请求越多，效果越明显。</p>
</blockquote>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>